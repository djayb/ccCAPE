{% extends "base.html" %}
{% block content %}
<section class="issue-header">
  <div>
    <h1>Ops Health</h1>
    <div class="meta-row">Freshness, reliability, and coverage (free-data proxy).</div>
  </div>
</section>

<section class="issue-layout">
  <article class="panel">
    <h2>Latest Ingestion</h2>
    {% if not pipeline %}
      <p class="muted">No pipeline runs found.</p>
    {% else %}
      <p><strong>Status:</strong> {{ pipeline.status }}</p>
      <p><strong>Started:</strong> {{ pipeline.run_started_at }}</p>
      <p><strong>Completed:</strong> {{ pipeline.run_completed_at }}</p>
      {% if pipeline.quality %}
        <p><strong>Latest price date:</strong> {{ pipeline.quality.get("latest_price_date", "-") }} ({{ pipeline.quality.get("price_age_days", "-") }} days)</p>
        <p><strong>Latest CPI date:</strong> {{ pipeline.quality.get("latest_cpi_date", "-") }} ({{ pipeline.quality.get("cpi_age_days", "-") }} days)</p>
        <p><strong>Latest Shiller date:</strong> {{ pipeline.quality.get("shiller_latest_observation_date", "-") }} ({{ pipeline.quality.get("shiller_age_days", "-") }} days)</p>
        <p><strong>Facts CIKs:</strong> {{ pipeline.quality.get("facts_cik_count", "-") }}</p>
        <p><strong>Priced symbols:</strong> {{ pipeline.quality.get("priced_symbol_count", "-") }}</p>
        {% if pipeline.quality.get("warnings") %}
          <div class="muted" style="margin-top: 0.6rem;">Warnings:</div>
          <ul>
            {% for w in pipeline.quality.get("warnings", []) %}
              <li>{{ w }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endif %}
    {% endif %}
  </article>

  <article class="panel">
    <h2>Latest Calculation</h2>
    {% if not calc %}
      <p class="muted">No CC CAPE runs found.</p>
    {% else %}
      <p><strong>Run ID:</strong> {{ calc.run_id }}</p>
      <p><strong>Run At:</strong> {{ calc.run_at }}</p>
      <p><strong>As-of price date:</strong> {{ calc.latest_price_date }}</p>
      <p><strong>CC CAPE:</strong> {{ "%.4f"|format(calc.cc_cape) }}</p>
      {% if calc.shiller_cape is not none %}
        <p><strong>Shiller CAPE:</strong> {{ "%.4f"|format(calc.shiller_cape) }} {% if calc.shiller_cape_date %}<span class="muted">(as of {{ calc.shiller_cape_date }})</span>{% endif %}</p>
      {% endif %}
      {% if calc.cape_spread is not none %}
        <p><strong>Spread:</strong> {{ "%.4f"|format(calc.cape_spread) }}</p>
      {% endif %}
      <p><strong>Coverage:</strong> {{ calc.symbols_with_valid_cape }} / {{ calc.symbols_total }} valid CAPE</p>
      <p><strong>Weighting:</strong> <code>{{ calc.weighting_method }}</code> (mcap coverage {{ "%.3f"|format(calc.market_cap_coverage) }})</p>
    {% endif %}
  </article>
</section>

<section class="panel" style="margin-top: 1rem;">
  <h2>Monthly Series</h2>
  {% if not series %}
    <p class="muted">No monthly series found yet.</p>
    <p class="muted">Run: <code>python3 scripts/backfill_cc_cape_series_free.py --series-years 10 --update-tracker</code></p>
  {% else %}
    <p><strong>As-of constituents:</strong> {{ series.as_of_constituents_date }}</p>
    <p><strong>Range:</strong> {{ series.min_observation_date }} to {{ series.max_observation_date }}</p>
    <p><strong>Observations:</strong> {{ series.count }}</p>
    <p><strong>Latest CC CAPE:</strong> {{ "%.4f"|format(series.latest_cc_cape) }}</p>
    <p class="muted">Export: <a href="/metrics/cc-cape/export/series_monthly.csv?as_of_constituents_date={{ series.as_of_constituents_date }}">series_monthly.csv</a></p>
  {% endif %}
</section>

{% endblock %}

